---
title: "Mapping Assignment"
author: 'Team 7: Rong Li, Minqi Li, Zhiwei Liang'
date: "10/28/2020"
output: pdf_document
---

```{r read_data, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(warning = FALSE)
library(tidyverse)
library(knitr)    
library(stringr)
library(ggmap)
library(magrittr)
library(dplyr)
library(drat)
library(hurricaneexposuredata)
library(hurricaneexposure)
library(magrittr)
library(tmap)
library(tmaptools)
library(maps)
library(usmap)
library(sp)
library(sf)
library(leaflet)
addRepo("geanders")
```


## The first map for Floyd-1999 made with ggplot2

```{r, warning=FALSE}
## load data
data("hurr_tracks")
data("rain")

MainStates <- map_data("state")
AllCounty <- map_data("county")
counties33 <- c("texas", "oklahoma", "kansas", "louisiana", "arkansas", "missouri", "lowa", "wisconsin", "michigan", "illinois", "indiana", "ohio", "kentucky", "tennessee", "alabama", "mississippi",  "florida", "georgia", "south carolina", "north carolina", "virginia", "west virginia", "maryland", "delaware", "pennsylvania", "new jersey", "new york", "connecticut", "rhode island", "massachusetts", "vermont", "new hampshire", "maine")

my_states <- subset(MainStates, region %in% counties33)
my_counties <-subset(AllCounty, region %in% counties33)

## get the track data of storm Floyd-1999
Floyd <- hurr_tracks[which(hurr_tracks$storm_id == "Floyd-1999"),]

## get the rain data of storm Floyd-1999
Floydrain <- subset(rain, storm_id == "Floyd-1999")
sum_precip <- Floydrain %>% group_by(fips) %>% dplyr::summarise(Rainfall = sum(precip))
rain_county <- fips_info(sum_precip$fips)
Floydrain <- merge(sum_precip, rain_county, by = 'fips')
Floydrain$county %<>% str_replace(" County","")
Floydrain$full %<>% tolower()
Floydrain$county %<>% tolower()
a <- subset(Floydrain, full %in% counties33)
rainmap <- left_join(a, my_counties, by = c("county" = "subregion"))

## start to plot
ggplot() + 
  geom_polygon(data=my_counties, aes(x=long, y=lat, group=group),
               color="gray", fill="white", size = .1 ) + 
  geom_polygon(data = rainmap, aes(x=long, y=lat, group=group, fill = Rainfall), 
               color = "gray") + 
  geom_polygon(data=my_states, aes(x=long, y=lat, group=group),
               color="black", fill="white",  size = 0.5, alpha = .3) + 
  geom_path(aes(x = Floyd$longitude, y = Floyd$latitude), color = "red", size=0.4) + 
  scale_fill_gradient(low="white",high="blue") + 
  xlim(-108, -65) + 
  ylim(23, 50) + 
  ggtitle("Floyd-1999")
```


## The second map for Allison-2001 made with ggplot2

```{r,warning=FALSE}
## get the track data of storm Allison-2001
Allison <- hurr_tracks[which(hurr_tracks$storm_id == "Allison-2001"),]

## get the rain data of storm Allison-2001
Allisondata <- filter_storm_data(storm = "Allison-2001", include_rain = TRUE, distance_limit = 500, rain_limit = 175, days_included = -3:3, output_vars = c("fips", "tot_precip"))
rain_county <- fips_info(Allisondata$fips)
Allisondata <- merge(Allisondata, rain_county, by = 'fips')
Allisondata$county %<>% str_replace(" County","")
Allisondata$full %<>% tolower()
Allisondata$county %<>% tolower()
a <- subset(Allisondata, full %in% counties33)
rainmap <- left_join(a, my_counties, by = c("county" = "subregion"))

ggplot() + 
  geom_polygon(data=my_counties, aes(x=long, y=lat, group=group),
               color="gray", fill="white", size = .1 ) + 
  geom_polygon(data = rainmap, aes(x=long, y=lat, group=group, fill = "rainfall>175mm"), 
               color = "gray") + 
  geom_polygon(data=my_states, aes(x=long, y=lat, group=group),
               color="black", fill="white",  size = 0.5, alpha = .3) + 
  geom_path(aes(x = Allison$longitude, y = Allison$latitude), color = "red", size=0.4) + 
  xlim(-107, -65) + 
  ylim(25, 48) + 
  ggtitle("Allison-2001")
```



## The third map for Floyd-1999 made with tmap
```{r,warning=FALSE,fig.align='center'}
#fips match location
uscounty=st_as_sf(map('county',plot=F,fill=T))
colnames(county.fips)[2]=colnames(uscounty)[1]
uscounty=left_join(uscounty,county.fips,by='ID')

#floyd rain
rain_floyd=rain %>% filter(storm_id=='Floyd-1999')
total_rain_floyd = rain_floyd %>% group_by(fips) %>% summarise(storm_id=storm_id[1],precip=sum(precip)) 
total_rain_floyd = total_rain_floyd %>% mutate(fips=as.numeric(fips))
total_rain_floyd= right_join(uscounty,total_rain_floyd,'fips')

#floyd track line
hurr_floyd=hurr_tracks%>%filter(storm_id=="Floyd-1999")
track_floyd=cbind(longitude=hurr_floyd$longitude,latitude=hurr_floyd$latitude)
#the following codes refer to other's 
track_floyd=SpatialLines(list(Lines(Line(track_floyd),ID='Floyd-1999')))


#plot
tm_shape(total_rain_floyd)+
  tm_polygons('precip',title="Rainfall")+
  tm_layout(main.title="Floyd-1999 Rainfall",
            main.title.position="center") +
tm_shape(track_floyd)+
  tm_lines(col = "red",lwd = 3)
```

## The fourth map for Allison-2001 made with tmap

We extract data from rain dataset and match fips with list format of longitude and latitude. Besides, we extract data from hurr_tracks dataset and process data into format that can be read with tmap packages.

```{r,fig.align='center'}
## match fips with list format of longitude and latitude

data("county.fips")
ll<-st_as_sf(map("county", fill=T, plot = F))
county <- ll %>% 
  right_join(county.fips, by = c("ID" = "polyname"))

## extract data that storm id is Allison-2001, distance limit is 500 and rain limit is 175
allison_data<-filter_storm_data(storm="Allison-2001",distance_limit=500, rain_limit=175, include_rain = TRUE,days_included = -3:3, output_vars = c("fips","tot_precip")) 

allison_data$fips<-as.numeric(allison_data$fips)
allison_limit <- county %>%
  left_join(allison_data, by=c("fips"="fips"))
allison_limit<-na.omit(allison_limit)

## extract data that storm id is Allison-2001
allison_data_all<-filter_storm_data(storm="Allison-2001", include_rain = TRUE, days_included = -3:3, output_vars = c("fips","tot_precip")) 

allison_data_all$fips<-as.numeric(allison_data_all$fips)
allison_all <- county %>%
  right_join(allison_data_all, by=c("fips"="fips"))
allison_all<-na.omit(allison_all)
allison_all<-allison_all[1:2357,]

## hurricane track
data("hurr_tracks")
allison_hurr<-hurr_tracks %>%
  filter(storm_id=="Allison-2001")
allison_hurr_sf <- st_as_sf(allison_hurr, coords = c("longitude", "latitude"), crs = 4326)

## map
tm_shape(allison_all)+
  tm_borders("black", lwd = .3)+
  tm_shape(allison_limit)+
  tm_polygons(col='tot_precip', title="rain>175mm")+
  tm_shape(allison_hurr_sf) +
  tm_dots(col='red')+
  tm_layout(main.title="Allison-2001",
            main.title.position="center")
```








